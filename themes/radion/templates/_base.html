{% import "macros/post_macros.html" as post_macros %}
{% import "macros/index_macros.html" as index_macros %}

<!doctype html>
<html lang="{{ config.default_language | default(value='en') }}" data-theme="{{ config.extra.theme_mode | default(value='toggle') }}">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Enable responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{% if page %}{{ page.permalink }}{% else %}{{ config.base_url }}{% endif %}" />
    
    <!-- Robots meta -->
    {% if page and page.extra.noindex %}
    <meta name="robots" content="noindex, nofollow" />
    {% else %}
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
    {% endif %}

    {% block meta_description %}
      {% if page and page.description %}
        <meta name="description" content="{{ page.description }}" />
        <meta property="og:description" content="{{ page.description }}" />
        <meta property="twitter:description" content="{{ page.description }}" />
      {% elif page and page.summary %}
        {% set content_desc = page.summary | striptags %}
        <meta name="description" content="{{ content_desc }}" />
        <meta property="og:description" content="{{ content_desc }}" />
        <meta property="twitter:description" content="{{ content_desc }}" />
      {% elif config.description %}
        <meta name="description" content="{{ config.description }}" />
        <meta property="og:description" content="{{ config.description }}" />
        <meta property="twitter:description" content="{{ config.description }}" />
      {% endif %}
    {% endblock meta_description %}

    <!-- Title -->
    {% if page and page.title %}
      {% set title = page.title ~ " | " ~ config.title %}
    {% else %}
      {% set title = config.title %}
    {% endif %}
    <title>{% block title %}{{ title }}{% endblock title %}</title>
    
    <!-- Author -->
    {% if page and config.extra.author %}
    <meta name="author" content="{{ config.extra.author }}" />
    {% endif %}
    
    <!-- Article specific meta tags -->
    {% if page %}
    {% if page.date %}
    <meta property="article:published_time" content="{{ page.date | date(format='%+') }}" />
    {% endif %}
    {% if page.updated %}
    <meta property="article:modified_time" content="{{ page.updated | date(format='%+') }}" />
    {% endif %}
    {% if page.taxonomies.tags %}
    {% for tag in page.taxonomies.tags %}
    <meta property="article:tag" content="{{ tag }}" />
    {% endfor %}
    {% endif %}
    {% if page.taxonomies.categories %}
    {% for category in page.taxonomies.categories %}
    <meta property="article:section" content="{{ category }}" />
    {% endfor %}
    {% endif %}
    {% endif %}

    <!-- Additional Facebook Meta Tags -->
    <meta property="og:site_name" content="{{ config.title }}" />
    <meta
      property="og:url"
      content="{% if page %}{{ page.permalink }}{% else %}{{ config.base_url }}{% endif %}"
    />
    <meta
      property="og:type"
      content="{% if page %}article{% else %}website{% endif %}"
    />
    <meta property="og:title" content="{% block og_title %}{{ title }}{% endblock og_title %}" />

    <!-- Additional Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:url"
      content="{% if page %}{{ page.permalink }}{% else %}{{ config.base_url }}{% endif %}"
    />
    <meta name="twitter:title" content="{% block twitter_title %}{{ title }}{% endblock twitter_title %}" />

    <!-- Cover images -->
           {% set cover_image = config.base_url ~ "/icons/favicon/web-app-manifest-512x512.png" %}
           {# Prefer explicit cover image URL, then static path, then page-local asset #}
           {% if page and page.extra.cover_image_url %}
             {% set_global cover_image = page.extra.cover_image_url %}
           {% elif page and page.extra.cover_image_static %}
             {% set_global cover_image = config.base_url ~ "/" ~ page.extra.cover_image_static | trim_start_matches(pat='/') %}
           {% elif page and page.extra.cover_image and page.assets %}
      {% for asset in page.assets %}
        {% if asset is ending_with(page.extra.cover_image) %}
          {% set_global cover_image = config.base_url ~ asset %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <meta
      property="og:image"
      content="{{ cover_image }}"
    />

    <meta
      name="twitter:image"
      content="{{ cover_image }}"
    />



    <!-- Favicons -->
           {% if config.extra.favicon | default (value="true") %}
           <!-- PNG + ICO (some clients ignore SVG favicons) -->
           <link
             rel="icon"
             type="image/png"
             sizes="96x96"
             href="{{ config.base_url }}/icons/favicon/favicon-96x96.png?v=3"
           />
           <link
             rel="apple-touch-icon"
             sizes="180x180"
             href="{{ config.base_url }}/icons/favicon/apple-touch-icon.png?v=3"
           />
           <link
             rel="shortcut icon"
             href="{{ config.base_url }}/icons/favicon/favicon.ico?v=3"
           />
           {% endif %}

    <!-- RSS Feed -->
    {% if config.generate_feeds %}
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS"
      href="{{ get_url(path='atom.xml') | safe }}"
    />
    {% endif %}

    <!-- Load Styles -->
    {% block styles %}
      <link
        rel="stylesheet"
        href="{{ get_url(path='site.css', trailing_slash=false) | safe }}"
      />
    {% endblock styles %}

    <!-- Load Fonts -->
    {% include "partials/fonts.html" %}

    <!-- Pass Theme Preference as Data Attribute -->
    <script src="{{ get_url(path='js/init-theme.js', trailing_slash=false) | safe }}"></script>

    <!-- Reference return to click position script -->
    <script defer src="{{ get_url(path='js/reference-return.js', trailing_slash=false) | safe }}"></script>

    <!-- Additional scripts -->
    {% block scripts %}
      {% if config.extra.codeblock %}
        <script defer src="{{ get_url(path='js/codeblock.js', trailing_slash=false) | safe }}"></script>
      {% endif %}
            {% if config.extra.theme_mode == "toggle" %}
              <script defer src="{{ get_url(path='js/toggle-theme.js', trailing_slash=false) | safe }}"></script>
            {% endif %}
      {% include "partials/latex.html" %}
      {% include "partials/search.html" %}
    {% endblock scripts %}
    
    <!-- Structured Data (JSON-LD) -->
    {% block structured_data %}
    {% if page %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ page.title }}",
      {% if page.description %}
      "description": "{{ page.description }}",
      {% elif page.summary %}
      "description": "{{ page.summary | striptags }}",
      {% else %}
      "description": "{{ config.description }}",
      {% endif %}
      {% if page.date %}
      "datePublished": "{{ page.date | date(format='%+') }}",
      {% endif %}
      {% if page.updated %}
      "dateModified": "{{ page.updated | date(format='%+') }}",
      {% endif %}
      "author": {
        "@type": "Person",
        "name": "{{ config.extra.author | default(value='Oshadha G') }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": "{{ config.title }}",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ config.base_url }}/icons/favicon/web-app-manifest-512x512.png"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ page.permalink }}"
      },
      "url": "{{ page.permalink }}"
    }
    </script>
    {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "{{ config.title }}",
      "description": "{{ config.description }}",
      "url": "{{ config.base_url }}",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ config.base_url }}/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    {% endif %}
    {% endblock structured_data %}
    
    <!-- Google Analytics (GA4) -->
    {% if config.extra.google_analytics_id and config.extra.google_analytics_id != "" %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.extra.google_analytics_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ config.extra.google_analytics_id }}', {
        'anonymize_ip': true,
        'respect_dnt': true
      });
    </script>
    {% endif %}
  </head>

  <!-- Body element (contents of the page) -->
  <body class="hack main container">
    {% block content %}
    {% block header %}
      {{ index_macros::header(config=config) }}
    {% endblock header %}

    <main>
      {% block main %}
      {% endblock main %}
    </main>
    {% endblock content %}
  </body>
</html>
